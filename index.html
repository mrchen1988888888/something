<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥‡å¼‚åšå£«ç²’å­ç³»ç»Ÿ - ç§»åŠ¨ç‰ˆ</title>
    <style>
        /* --- ç§»åŠ¨ç«¯åŸºç¡€è®¾ç½® --- */
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        /* ç”»å¸ƒ */
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #input-video { display: none; } /* éšè—åŸå§‹ç”»é¢ */

        /* --- å¯åŠ¨é¡µ (è§£å†³ç§»åŠ¨ç«¯æƒé™é—®é¢˜) --- */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .start-btn {
            padding: 15px 40px; font-size: 18px; color: white;
            background: linear-gradient(45deg, #ff6b00, #ff2200);
            border: none; border-radius: 30px; font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 68, 0, 0.4);
            animation: pulse 2s infinite;
        }
        .loading-text { color: #888; margin-top: 15px; font-size: 12px; }

        /* --- æ™ºèƒ½å¼•å¯¼ HUD (æ ¸å¿ƒäº¤äº’æç¤º) --- */
        #gesture-hud {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            z-index: 10; width: 80%; text-align: center; pointer-events: none;
            transition: all 0.3s ease;
        }
        .hud-icon { font-size: 40px; display: block; margin-bottom: 5px; filter: drop-shadow(0 0 10px rgba(0,255,255,0.5)); }
        .hud-text { 
            color: rgba(255, 255, 255, 0.9); font-size: 16px; font-weight: 500; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); background: rgba(0,0,0,0.3);
            padding: 8px 16px; border-radius: 20px; display: inline-block;
            backdrop-filter: blur(4px);
        }
        
        /* çŠ¶æ€æŒ‡ç¤ºæ¡ - ç±»ä¼¼äºè¡€æ¡/èƒ½é‡æ¡ */
        #energy-bar-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; z-index: 20;
        }
        #energy-bar {
            width: 0%; height: 100%; background: #00ffff; box-shadow: 0 0 10px #00ffff;
            transition: width 0.2s, background-color 0.3s;
        }

        /* --- åº•éƒ¨æ§åˆ¶æ  (æ‰‹æœºç«¯æ“ä½œåŒº) --- */
        #controls-bar {
            position: absolute; bottom: 30px; left: 20px; right: 20px; z-index: 20;
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 20px; padding: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: space-between;
        }
        .color-wrapper {
            display: flex; align-items: center; gap: 10px; color: white; font-size: 14px;
        }
        input[type="color"] {
            width: 30px; height: 30px; border: none; border-radius: 50%; overflow: hidden; padding: 0;
            background: none; box-shadow: 0 0 5px rgba(255,255,255,0.3);
        }
        .debug-toggle {
            font-size: 12px; color: #aaa; background: rgba(255,255,255,0.1); 
            padding: 5px 10px; border-radius: 8px;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <!-- 1. å¯åŠ¨é¡µ -->
    <div id="start-screen">
        <button class="start-btn" id="init-btn">ç‚¹å‡»å¼€å¯é­”æ³•ä½“éªŒ</button>
        <div class="loading-text" id="loading-msg">éœ€å…è®¸æ‘„åƒå¤´æƒé™ â€¢ æ¨èç«–å±ä½“éªŒ</div>
    </div>

    <!-- 2. HUD å¼•å¯¼å±‚ -->
    <div id="gesture-hud">
        <span class="hud-icon">ğŸ‘‹</span>
        <span class="hud-text">è¯·å°†æ‰‹ä¼¸å…¥é•œå¤´èŒƒå›´</span>
    </div>
    
    <!-- 3. èƒ½é‡æ¡ -->
    <div id="energy-bar-container"><div id="energy-bar"></div></div>

    <!-- 4. åº•éƒ¨æ§åˆ¶æ  -->
    <div id="controls-bar">
        <div class="color-wrapper">
            <input type="color" id="color-picker" value="#00ffff">
            <span>ç²’å­è¾‰å…‰</span>
        </div>
        <div class="debug-toggle" id="fps-counter">FPS: 60</div>
    </div>

    <!-- 5. æ ¸å¿ƒç”»å¸ƒ -->
    <div id="canvas-container"></div>
    <video id="input-video" playsinline webkit-playsinline></video>

    <!-- åº“æ–‡ä»¶å¼•å…¥ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script type="module">
        // === æ ¸å¿ƒé…ç½® ===
        const CONFIG = {
            mobileParticleCount: 1200, // æ‰‹æœºç«¯å‡å°‘ç²’å­æ•°ä»¥ä¿æµç•…
            desktopParticleCount: 3000,
            colors: {
                idle: '#00ffff',
                active: '#ff2200',
                magic: '#ffaa00'
            }
        };

        // === çŠ¶æ€ç®¡ç† ===
        const State = {
            hand: 'NONE', // NONE, OPEN, CLOSED, DOUBLE
            isMagic: false,
            energy: 0, // 0-100 ç”¨äºUIæ˜¾ç¤º
            currentColor: new THREE.Color(CONFIG.colors.idle)
        };

        // === 1. å¼•å¯¼æç¤ºç³»ç»Ÿ (HUD System) ===
        class HUDSystem {
            constructor() {
                this.hud = document.getElementById('gesture-hud');
                this.icon = this.hud.querySelector('.hud-icon');
                this.text = this.hud.querySelector('.hud-text');
                this.bar = document.getElementById('energy-bar');
                this.lastState = '';
            }

            update(handState, isMagic) {
                // çŠ¶æ€æœªæ”¹å˜åˆ™ä¸åˆ·æ–°DOMï¼Œä¼˜åŒ–æ€§èƒ½
                if (this.lastState === handState && this.lastMagic === isMagic) return;
                this.lastState = handState;
                this.lastMagic = isMagic;

                if (isMagic) {
                    this.show('âœ¨', 'è‡³å°Šæ³•å¸ˆæ¨¡å¼å·²æ¿€æ´»ï¼', '#ffaa00');
                    return;
                }

                switch (handState) {
                    case 'NONE':
                        this.show('ğŸ‘‹', 'å¯»æ‰¾æ‰‹éƒ¨ä¿¡å·...', '#333');
                        break;
                    case 'OPEN':
                        this.show('âœ‹', 'å¼ å¼€ï¼šé‡Šæ”¾èƒ½é‡', '#00ffff');
                        break;
                    case 'CLOSED':
                        this.show('âœŠ', 'æ¡æ‹³ï¼šå‡èšç²’å­', '#ff3300');
                        break;
                    case 'DOUBLE':
                        this.show('ğŸ™', 'åŒæ‰‹åˆåï¼šè§¦å‘æ³•é˜µ', '#ffaa00');
                        break;
                }
            }

            show(icon, text, barColor) {
                this.icon.textContent = icon;
                this.text.textContent = text;
                this.bar.style.backgroundColor = barColor;
                this.bar.style.boxShadow = `0 0 10px ${barColor}`;
                
                // ç®€å•çš„è¿›å…¥åŠ¨ç”»
                this.hud.style.transform = "translateX(-50%) scale(1.1)";
                setTimeout(() => {
                    this.hud.style.transform = "translateX(-50%) scale(1)";
                }, 100);
            }

            updateEnergy(val) {
                this.bar.style.width = `${val}%`;
            }
        }

        // === 2. 3D æ¸²æŸ“å¼•æ“ (Three.js Engine) ===
        class Engine {
            constructor() {
                this.container = document.getElementById('canvas-container');
                this.scene = new THREE.Scene();
                // ç§»åŠ¨ç«¯é€‚å½“å¢åŠ è¿·é›¾é®ç›–è¿œå¤„ï¼Œæå‡æ²‰æµ¸æ„Ÿ
                this.scene.fog = new THREE.FogExp2(0x050505, 0.03);

                // æ‘„åƒæœºé€‚é…ç«–å±
                this.camera = new THREE.PerspectiveCamera(80, window.innerWidth / window.innerHeight, 0.1, 100);
                this.camera.position.z = 4;

                this.renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true }); // å…³é—­æŠ—é”¯é½¿æ¢å–æ€§èƒ½
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // é™åˆ¶åƒç´ æ¯”ï¼Œçœç”µ
                this.container.appendChild(this.renderer.domElement);

                this.clock = new THREE.Clock();
                this.particles = null;
                this.magicCircle = null;
                
                this.initWorld();
                window.addEventListener('resize', () => this.resize());
            }

            initWorld() {
                // --- ç²’å­ç¾¤ ---
                const count = window.innerWidth < 600 ? CONFIG.mobileParticleCount : CONFIG.desktopParticleCount;
                const geometry = new THREE.BufferGeometry();
                const pos = new Float32Array(count * 3);
                
                for(let i=0; i<count*3; i++) {
                    pos[i] = (Math.random() - 0.5) * 8;
                }
                
                geometry.setAttribute('position', new THREE.BufferAttribute(pos, 3));
                
                const mat = new THREE.PointsMaterial({
                    size: 0.1,
                    color: State.currentColor,
                    transparent: true,
                    opacity: 0.8,
                    blending: THREE.AdditiveBlending,
                    sizeAttenuation: true
                });

                this.particles = new THREE.Points(geometry, mat);
                this.scene.add(this.particles);

                // --- é­”æ³•é˜µ (ç®€åŒ–ç‰ˆï¼Œé€‚åˆæ‰‹æœºæ¸²æŸ“) ---
                this.magicCircle = new THREE.Group();
                this.magicCircle.visible = false;
                
                // å¤–åœˆ
                const ring = new THREE.Mesh(
                    new THREE.RingGeometry(1.2, 1.3, 32),
                    new THREE.MeshBasicMaterial({ color: 0xffaa00, side: THREE.DoubleSide, transparent: true, opacity: 0.6 })
                );
                // å†…åœˆæ­£æ–¹å½¢
                const square = new THREE.LineSegments(
                    new THREE.EdgesGeometry(new THREE.PlaneGeometry(1.8, 1.8)),
                    new THREE.LineBasicMaterial({ color: 0xff4400 })
                );
                
                this.magicCircle.add(ring);
                this.magicCircle.add(square);
                this.magicCircle.children[1].name = "inner";
                this.scene.add(this.magicCircle);
            }

            changeColor(hex) {
                State.currentColor.set(hex);
                if(this.particles) this.particles.material.color.lerp(State.currentColor, 0.1);
            }

            render() {
                const delta = this.clock.getDelta();
                const time = this.clock.getElapsedTime();

                // ç²’å­åŸºç¡€æ—‹è½¬
                if(this.particles) {
                    // æ ¹æ®çŠ¶æ€æ”¹å˜é€Ÿåº¦
                    let speed = 0.1;
                    let scaleTarget = 1.0;
                    
                    if(State.hand === 'CLOSED') { speed = 2.0; scaleTarget = 0.4; } // èšèƒ½
                    if(State.hand === 'OPEN') { speed = 0.05; scaleTarget = 1.8; } // æ‰©æ•£
                    
                    this.particles.rotation.y += speed * delta;
                    
                    // å‘¼å¸ç¼©æ”¾
                    const currentScale = this.particles.scale.x;
                    const newScale = currentScale + (scaleTarget - currentScale) * 0.05;
                    this.particles.scale.set(newScale, newScale, newScale);
                    
                    // é¢œè‰²å®æ—¶æ›´æ–°
                    this.particles.material.color = State.currentColor;
                }

                // é­”æ³•é˜µåŠ¨ç”»
                if(State.isMagic) {
                    this.magicCircle.visible = true;
                    this.magicCircle.rotation.z -= delta * 0.5;
                    const inner = this.magicCircle.getObjectByName("inner");
                    if(inner) inner.rotation.z += delta * 2;
                    
                    // è„‰å†²æ•ˆæœ
                    const pulse = 1 + Math.sin(time * 10) * 0.1;
                    this.magicCircle.scale.set(pulse, pulse, pulse);
                } else {
                    this.magicCircle.visible = false;
                }

                this.renderer.render(this.scene, this.camera);
                requestAnimationFrame(() => this.render());
            }

            resize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }
        }

        // === 3. è§†è§‰è¯†åˆ« (Vision Controller) ===
        class Vision {
            constructor(hud) {
                this.hud = hud;
                this.video = document.getElementById('input-video');
                this.hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
                
                // ç§»åŠ¨ç«¯æ€§èƒ½é…ç½®
                this.hands.setOptions({
                    maxNumHands: 2,
                    modelComplexity: 1, // 0=Lite(æœ€å¿«), 1=Full(å‡†ç¡®)
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                this.hands.onResults(this.onResults.bind(this));
            }

            async start() {
                const camera = new Camera(this.video, {
                    onFrame: async () => await this.hands.send({image: this.video}),
                    width: 480, height: 640, // é™ä½å¤„ç†åˆ†è¾¨ç‡ï¼Œæå‡FPS
                    facingMode: 'user' // å¼ºåˆ¶ä½¿ç”¨å‰ç½®æ‘„åƒå¤´
                });
                await camera.start();
            }

            onResults(results) {
                const landmarks = results.multiHandLandmarks;

                if (!landmarks || landmarks.length === 0) {
                    State.hand = 'NONE';
                    State.isMagic = false;
                    State.energy = Math.max(0, State.energy - 5);
                } else {
                    State.energy = Math.min(100, State.energy + 2);

                    // åŒæ‰‹åˆ¤æ–­
                    if(landmarks.length === 2) {
                        const h1 = landmarks[0][0];
                        const h2 = landmarks[1][0];
                        const dist = Math.hypot(h1.x - h2.x, h1.y - h2.y);
                        
                        if(dist < 0.1) { // åŒæ‰‹é è¿‘
                            State.hand = 'DOUBLE';
                            State.isMagic = true;
                        } else {
                            State.isMagic = false;
                            this.checkSingleHand(landmarks[0]); // å³ä½¿åŒæ‰‹ï¼Œå¦‚æœæ²¡åˆåï¼Œä¼˜å…ˆåˆ¤æ–­ç¬¬ä¸€åªæ‰‹
                        }
                    } else {
                        // å•æ‰‹åˆ¤æ–­
                        State.isMagic = false;
                        this.checkSingleHand(landmarks[0]);
                    }
                }

                // æ›´æ–°UI
                this.hud.update(State.hand, State.isMagic);
                this.hud.updateEnergy(State.energy);
            }

            checkSingleHand(lm) {
                // ç®€å•è®¡ç®—ï¼šæŒ‡å°–åˆ°æ‰‹è…•çš„è·ç¦»æ€»å’Œ
                // 0:Wrist, 8:IndexTip, 12:MiddleTip, 16:RingTip, 20:PinkyTip
                const wrist = lm[0];
                const tips = [8, 12, 16, 20];
                let totalDist = 0;
                tips.forEach(idx => {
                    totalDist += Math.hypot(wrist.x - lm[idx].x, wrist.y - lm[idx].y);
                });
                const avgDist = totalDist / 4;
                
                // é˜ˆå€¼åˆ¤å®š
                if(avgDist < 0.25) State.hand = 'CLOSED';
                else State.hand = 'OPEN';
            }
        }

        // === ä¸»ç¨‹åºå…¥å£ ===
        const hud = new HUDSystem();
        const engine = new Engine();
        const vision = new Vision(hud);

        // ç»‘å®šUIäº‹ä»¶
        const colorPicker = document.getElementById('color-picker');
        colorPicker.addEventListener('input', (e) => engine.changeColor(e.target.value));

        // å¯åŠ¨æµç¨‹
        const startBtn = document.getElementById('init-btn');
        const startScreen = document.getElementById('start-screen');
        const loadMsg = document.getElementById('loading-msg');

        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.textContent = "æ­£åœ¨åˆå§‹åŒ–å¼•æ“...";
            loadMsg.textContent = "æ­£åœ¨åŠ è½½ AI æ¨¡å‹ï¼Œè¯·ç¨å€™ (é¦–æ¬¡åŠ è½½çº¦éœ€5-10ç§’)";

            try {
                // å¿…é¡»ç”±ç”¨æˆ·ç‚¹å‡»è§¦å‘è§†é¢‘æµ
                await vision.start();
                
                // å¯åŠ¨3Då¾ªç¯
                engine.render();

                // éšè—å¯åŠ¨é¡µ
                startScreen.style.opacity = 0;
                setTimeout(() => startScreen.style.display = 'none', 500);
            } catch (err) {
                console.error(err);
                startBtn.textContent = "å¯åŠ¨å¤±è´¥";
                loadMsg.textContent = "è¯·æ£€æŸ¥æµè§ˆå™¨æ‘„åƒå¤´æƒé™ï¼Œæˆ–ç¡®ä¿ä½¿ç”¨HTTPSè®¿é—®ã€‚";
                alert("æ— æ³•å¼€å¯æ‘„åƒå¤´: " + err.message);
            }
        });

    </script>
</body>
</html>
